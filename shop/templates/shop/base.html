{% load static %}
<!doctype html>
<html lang="en">
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    {% include 'shop/base/css.html' %}
    <title>Hello, world!</title>
</head>
<body>
{% include 'shop/base/navbar.html' %}
<div class="container mt-3">
    {% block content %}
    {% endblock %}
</div>
{% include 'shop/base/js.html' %}
<script>
    $(document).ready(function () {
        var productForm=$(".form-product-ajax");
        productForm.submit(function (event) {
            event.preventDefault();
            var thisForm=$(this);
            //var actionEndpoint=thisForm.attr("action");
            var actionEndpoint = thisForm.attr('data-endpoint');
            var httpMethod=thisForm.attr("method");
            var formData=thisForm.serialize();
            $.ajax({
                url:actionEndpoint,
                method:httpMethod,
                data:formData,

                success:function (data) {
                    var submitSpan=thisForm.find('.submit-span');
                    if(data.added){
                        submitSpan.html('<button type="submit" class="btn btn-danger">Remove</button>')
                    }
                    else {
                        submitSpan.html('<button type="submit" class="btn btn-success">Add to cart</button>')
                    }
                var navbarCount=$('.navbar-cart-count');
                navbarCount.text(data.cartItemCount);

                var currentPath=window.location.href;
                if (window.location.href.indexOf('cart')!=-1){
                    refreshCart();
                }
                },
            });
        });
        function refreshCart() {
            console.log('updating');

            var cartTable=$('.cart-table');
            var cartBody = cartTable.find('.cart-body');
            var productRows = cartBody.find(".cart-product");
            var currentUrl = location.href;
            var refreshCartUrl='/api/cart/';
            var refreshCartMethod="GET";
            var data={};
            $.ajax({
                url:refreshCartUrl,
                method: refreshCartMethod,
                data:data,
                success:function (data) {
                    var hiddenRemoveForm = $('.cart-item-remove-form');
                    if (data.products.length>0){
                        console.log(">0");
                        productRows.html("");
                        $.each(data.products, function (index, value) {
                            var newHiddenRemoveForm = hiddenRemoveForm.clone();
                            newHiddenRemoveForm.css("display", 'block');
                            newHiddenRemoveForm.find('.cart-item-id').val(value.id);
                            cartBody.prepend("<tr><th scope=\"row\">" + (index+1) +"</th><td><a href='"+value.url+"'>"+ value.title +"</a>"+newHiddenRemoveForm.html()+"</td><td>"+value.price+"</td></tr>");
                        });
                        $(".cart-total").text(data.total);
                    }else{
                        window.location.href=currentUrl
                    }
                },
                error:function (data) {
                    console.log('error');
                }
            })
        }
    })
</script>
</body>
</html>